# .github/workflows/deploy-zola-site.yml (Modified - Stage 1: Include WASM)
name: Deploy Zola Website with WASM to GitHub Pages

on:
  push:
    branches:
      - website
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout website branch
        uses: actions/checkout@v4
        # No 'ref' needed, defaults to 'website'

      - name: Set up Rust (for Zola)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Install Zola CLI
        uses: taiki-e/install-action@v2
        with:
          tool: zola@0.19.1

      # === WASM STABLE GAME FETCHING STEPS ===
      - name: Get Latest Stable Release Tag
        id: latest_release
        run: |
          # Get the latest release tag (excluding pre-releases)
          LATEST_TAG=$(gh release list --limit 1 --exclude-pre-releases --json tagName --jq '.[0].tagName' || echo "none")
          echo "Latest Release Tag: $LATEST_TAG"
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Latest Stable WASM Game
        if: steps.latest_release.outputs.LATEST_TAG != 'none' && steps.latest_release.outputs.LATEST_TAG != 'null'
        run: |
          gh release download "${{ steps.latest_release.outputs.LATEST_TAG }}" --pattern "unhaunter-*wasm.zip" -O latest-wasm-release.zip
          unzip latest-wasm-release.zip -d wasm-release-temp
          cp -Rv wasm-release-temp/* static/wasm/main/
          echo "Latest stable WASM game downloaded and extracted to static/wasm/main/"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup temp WASM download
        if: steps.latest_release.outputs.LATEST_TAG != 'none' && steps.latest_release.outputs.LATEST_TAG != 'null'
        run: rm -rf wasm-release-temp latest-wasm-release.zip

      # === WASM BETA GAME FETCHING STEPS ===
      - name: Get Latest Beta Release Tag
        id: latest_beta_release
        run: |
          # Get the latest release tag (including pre-releases)
          BETA_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' || echo "none")
          echo "Latest Release Tag: $BETA_TAG"
          echo "BETA_TAG=$BETA_TAG" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Latest Beta WASM Game
        if: steps.latest_beta_release.outputs.BETA_TAG != 'none' && steps.latest_beta_release.outputs.BETA_TAG != 'null'
        run: |
          gh release download "${{ steps.latest_beta_release.outputs.BETA_TAG }}" --pattern "unhaunter-*wasm.zip" -O beta-wasm-release.zip
          unzip beta-wasm-release.zip -d wasm-beta-temp
          cp -Rv wasm-beta-temp/* static/wasm/beta/
          echo "Latest beta WASM game downloaded and extracted to static/wasm/beta/"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup temp WASM download
        if: steps.latest_beta_release.outputs.BETA_TAG != 'none' && steps.latest_beta_release.outputs.BETA_TAG != 'null'
        run: rm -rf wasm-beta-temp beta-wasm-release.zip

      # === BUILD SITE AND UPLOAD ====
      - name: Build Zola site
        run: zola build
        # Zola will now include the WASM game from static/wasm/main/pkg

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public # Upload 'public' directory

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
